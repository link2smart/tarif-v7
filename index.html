<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Tarifs CMGP-CAS (Dropbox Sync)</title>
    <!-- Biblioth√®ques React & UI -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Moteurs PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Configuration PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- SERVICES DROPBOX ---
        const DROPBOX_API_URL = "https://api.dropboxapi.com/2";
        const DROPBOX_CONTENT_URL = "https://content.dropboxapi.com/2";

        const dbxListFolder = async (token, path) => {
            const res = await fetch(`${DROPBOX_API_URL}/files/list_folder`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path === '/' ? '' : path, recursive: false, include_media_info: false })
            });
            if (!res.ok) throw new Error(await res.text());
            return await res.json();
        };

        const dbxDownloadFile = async (token, path) => {
            const res = await fetch(`${DROPBOX_CONTENT_URL}/files/download`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Dropbox-API-Arg': JSON.stringify({ path }) }
            });
            if (!res.ok) throw new Error(await res.text());
            return await res.blob();
        };

        // Fonction d'attente pour √©viter de saturer l'IA
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- IA GOOGLE ---
        const apiKeyIA = "AIzaSyC6-bG7HPhBnjmctpJPPYI29OSiM_S4JFg"; 
        
        const callIA = async (payload) => {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKeyIA}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            return await res.json();
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size, class: className } });
                    iconRef.current.innerHTML = `<i data-lucide="${name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase()}"></i>`;
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        function App() {
            // --- ETATS ---
            const [view, setView] = useState('login'); 
            const [adminTab, setAdminTab] = useState('sync'); 
            const [searchTab, setSearchTab] = useState('tarifs'); 
            
            const [tarifs, setTarifs] = useState([]);
            const [fichesTechniques, setFichesTechniques] = useState([]);
            const [syncInfo, setSyncInfo] = useState({ lastSync: null, recentFiles: [] });
            
            const [dbxConfig, setDbxConfig] = useState({ 
                token: '', 
                pathTarifs: '/Tarifs', 
                pathFT: '/Fiches' 
            });

            const [queryStr, setQueryStr] = useState('');
            const [ftQueryStr, setFtQueryStr] = useState('');
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');
            const [syncStatus, setSyncStatus] = useState(null); 
            const [syncLog, setSyncLog] = useState('');
            const fileInputRef = useRef(null); 

            // --- CHARGEMENT PERSISTANCE ---
            useEffect(() => {
                try {
                    const savedTarifs = localStorage.getItem('cmgp_dbx_tarifs');
                    const savedFT = localStorage.getItem('cmgp_dbx_ft');
                    const savedConfig = localStorage.getItem('cmgp_dbx_config');
                    const savedSync = localStorage.getItem('cmgp_dbx_sync_info');

                    if (savedTarifs) setTarifs(JSON.parse(savedTarifs));
                    if (savedFT) setFichesTechniques(JSON.parse(savedFT));
                    if (savedConfig) setDbxConfig(JSON.parse(savedConfig));
                    if (savedSync) setSyncInfo(JSON.parse(savedSync));
                } catch(e) {
                    console.error("Erreur chargement localStorage", e);
                }
            }, []);

            useEffect(() => { localStorage.setItem('cmgp_dbx_tarifs', JSON.stringify(tarifs)); }, [tarifs]);
            useEffect(() => { localStorage.setItem('cmgp_dbx_ft', JSON.stringify(fichesTechniques)); }, [fichesTechniques]);
            useEffect(() => { localStorage.setItem('cmgp_dbx_config', JSON.stringify(dbxConfig)); }, [dbxConfig]);
            useEffect(() => { localStorage.setItem('cmgp_dbx_sync_info', JSON.stringify(syncInfo)); }, [syncInfo]);

            // --- FONCTIONS SAUVEGARDE / RESTAURATION ---
            const handleExportConfig = () => {
                const data = { tarifs, fichesTechniques, dbxConfig, syncInfo, exportDate: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `cmgp_config_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            const handleImportConfig = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.tarifs) setTarifs(data.tarifs);
                        if (data.fichesTechniques) setFichesTechniques(data.fichesTechniques);
                        if (data.dbxConfig) setDbxConfig(data.dbxConfig);
                        if (data.syncInfo) setSyncInfo(data.syncInfo);
                        alert("Configuration restaur√©e !");
                    } catch (error) { alert("Fichier invalide."); }
                };
                reader.readAsText(file);
            };

            // --- NETTOYAGE JSON ROBUSTE ---
            const extractJSON = (text) => {
                // Cherche le premier { et le dernier } pour isoler le JSON du texte de l'IA
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    return text.substring(firstBrace, lastBrace + 1);
                }
                return text;
            };

            // --- LOGIQUE METIER IA & PARSING ---
            const analyzeTarifPDF = async (blob) => {
                try {
                    const arrayBuffer = await blob.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let allProducts = [];
                    
                    // On analyse les 2 premi√®res pages
                    for (let i = 1; i <= Math.min(pdf.numPages, 2); i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: ctx, viewport }).promise;
                        
                        // Prompt tr√®s strict pour l'IA
                        const result = await callIA({
                            contents: [{ parts: [{ text: "Extrais la liste des produits sous forme d'un objet JSON strict. Structure: { \"products\": [ { \"name\": \"Nom complet du produit\", \"price\": \"Prix num√©rique (ex: 120.50)\", \"packaging\": \"Unit√© (ex: 25 KG)\" } ] }. Ne mets RIEN d'autre que le JSON." }, { inlineData: { mimeType: "image/png", data: canvas.toDataURL('image/png').split(',')[1] } } ] }],
                            generationConfig: { responseMimeType: "application/json" }
                        });
                        
                        if (result.candidates && result.candidates[0].content) {
                            const rawText = result.candidates[0].content.parts[0].text;
                            const cleanJson = extractJSON(rawText);
                            
                            try {
                                const data = JSON.parse(cleanJson);
                                if (data.products && Array.isArray(data.products)) {
                                    // Normalisation des prix
                                    const cleanProducts = data.products.map(p => ({
                                        ...p,
                                        price: p.price ? String(p.price).replace(',', '.').replace(/[^0-9.]/g, '') : '0'
                                    }));
                                    allProducts.push(...cleanProducts);
                                }
                            } catch(jsonErr) {
                                console.warn("Erreur Parsing JSON IA:", jsonErr);
                            }
                        }
                    }
                    return allProducts;
                } catch (e) {
                    console.error("Erreur lecture PDF", e);
                    return []; 
                }
            };

            const analyzeFTName = async (blob, filename) => {
                return filename.replace(/\.pdf$/i, '').replace(/_/g, ' ');
            };

            // --- MOTEUR DE SYNC DROPBOX ---
            const runSync = async (forceRescan = false) => {
                if (!dbxConfig.token) return alert("Configurez le Token Dropbox d'abord.");
                
                setSyncStatus('loading');
                setSyncLog(forceRescan ? 'Re-scan COMPLET forc√©...' : 'D√©marrage synchronisation...');
                
                let localTarifs = forceRescan ? [] : [...tarifs];
                let updatesCount = 0;
                const newRecentFiles = [];

                try {
                    // 1. SYNC TARIFS
                    setSyncLog(`>>> Analyse Tarifs (${dbxConfig.pathTarifs})`);
                    try {
                        const listTarifs = await dbxListFolder(dbxConfig.token, dbxConfig.pathTarifs);
                        const validEntryIds = [];

                        for (const entry of listTarifs.entries) {
                            if (entry['.tag'] !== 'file' || !entry.name.toLowerCase().endsWith('.pdf')) continue;
                            
                            validEntryIds.push(entry.id);
                            const existing = localTarifs.find(t => t.id === entry.id);

                            // Force l'update si demand√© ou si pas de produits
                            const needsUpdate = forceRescan || !existing || existing.server_modified !== entry.server_modified || (!existing.products || existing.products.length === 0);

                            if (needsUpdate) {
                                setSyncLog(`Traitement IA : ${entry.name}...`);
                                try {
                                    const blob = await dbxDownloadFile(dbxConfig.token, entry.path_lower);
                                    await delay(1500); 
                                    const products = await analyzeTarifPDF(blob);
                                    
                                    if (products.length === 0) {
                                        setSyncLog(`‚ö†Ô∏è ${entry.name} : 0 produits. (Fichier ajout√© pour recherche par nom)`);
                                    } else {
                                        setSyncLog(`‚úÖ ${entry.name} : ${products.length} produits trouv√©s.`);
                                    }

                                    const newDoc = {
                                        id: entry.id,
                                        name: entry.name,
                                        path: entry.path_lower,
                                        server_modified: entry.server_modified,
                                        products: products,
                                        type: 'tarif'
                                    };
                                    
                                    // Mise √† jour imm√©diate
                                    setTarifs(prev => {
                                        const filtered = prev.filter(p => p.id !== entry.id);
                                        return [...filtered, newDoc];
                                    });
                                    // Mise √† jour locale pour la suite de la boucle
                                    localTarifs = [...localTarifs.filter(p => p.id !== entry.id), newDoc];

                                    newRecentFiles.push({ name: entry.name, type: 'tarif', date: new Date().toLocaleTimeString() });
                                    updatesCount++;

                                } catch (fileError) {
                                    setSyncLog(`‚ùå Erreur fichier ${entry.name} : ${fileError.message}`);
                                }
                            }
                        }
                        
                        // Nettoyage orphelins (si non forc√©, car forc√© vide d√©j√† tout)
                        if(!forceRescan) {
                             const cleaned = localTarifs.filter(t => validEntryIds.includes(t.id));
                             setTarifs(cleaned);
                        }

                    } catch (e) {
                        setSyncLog(`Erreur dossier Tarifs: ${e.message}`);
                    }

                    // 2. SYNC FICHES
                    setSyncLog(`>>> Analyse Fiches (${dbxConfig.pathFT})`);
                    try {
                        const listFT = await dbxListFolder(dbxConfig.token, dbxConfig.pathFT);
                        const validFTIds = [];

                        for (const entry of listFT.entries) {
                            if (entry['.tag'] !== 'file') continue;
                            validFTIds.push(entry.id);
                            
                            const existing = fichesTechniques.find(f => f.id === entry.id);
                            if (forceRescan || !existing || existing.server_modified !== entry.server_modified) {
                                const productName = await analyzeFTName(null, entry.name);
                                const newDoc = {
                                    id: entry.id,
                                    fileName: entry.name,
                                    productName: productName,
                                    path: entry.path_lower,
                                    server_modified: entry.server_modified,
                                    type: 'ft'
                                };
                                setFichesTechniques(prev => [...prev.filter(f => f.id !== entry.id), newDoc]);
                                updatesCount++;
                            }
                        }
                        if(!forceRescan) setFichesTechniques(prev => prev.filter(f => validFTIds.includes(f.id)));

                    } catch (e) {
                        setSyncLog(`Erreur dossier Fiches: ${e.message}`);
                    }

                    setSyncInfo({
                        lastSync: new Date().toLocaleString(),
                        recentFiles: [...newRecentFiles, ...syncInfo.recentFiles].slice(0, 10)
                    });
                    setSyncStatus('success');
                    setSyncLog(`Termin√© ! ${updatesCount} mises √† jour.`);

                } catch (globalError) {
                    setSyncStatus('error');
                    setSyncLog("Erreur critique : " + globalError.message);
                }
            };

            const openDropboxFile = async (path) => {
                if (!dbxConfig.token) return alert("Token manquant");
                try {
                    const res = await fetch(`${DROPBOX_API_URL}/files/get_temporary_link`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${dbxConfig.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: path })
                    });
                    const data = await res.json();
                    if (data.link) window.open(data.link, '_blank');
                    else alert("Impossible de g√©n√©rer le lien.");
                } catch (e) {
                    alert("Erreur ouverture fichier.");
                }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (loginForm.username.toLowerCase() === 'admin' && loginForm.password === 'admin') {
                    setView('search');
                } else {
                    setLoginError('Identifiants incorrects (admin/admin)');
                }
            };

            // --- RECHERCHE (HYBRIDE) ---
            const searchResults = useMemo(() => {
                if (queryStr.length < 2) return [];
                const res = [];
                const searchLower = queryStr.toLowerCase();

                tarifs.forEach(t => {
                    // 1. Recherche dans les produits extraits
                    if (t.products && t.products.length > 0) {
                        t.products.forEach(p => {
                            const pName = p.name ? String(p.name).toLowerCase() : "";
                            const pPack = p.packaging ? String(p.packaging).toLowerCase() : "";
                            
                            if (pName.includes(searchLower) || pPack.includes(searchLower)) {
                                res.push({ ...p, source: t.name, path: t.path, sourceId: t.id, type: 'product' });
                            }
                        });
                    }

                    // 2. Recherche de secours sur le nom du fichier (Si extraction √©chou√©e ou produit non trouv√©)
                    if (t.name.toLowerCase().includes(searchLower)) {
                        // On √©vite les doublons si possible, mais afficher le fichier est toujours utile
                        res.push({
                            name: "üìÇ " + t.name, 
                            price: "---",
                            packaging: "Catalogue PDF",
                            source: "Fichier Complet",
                            path: t.path,
                            sourceId: t.id,
                            type: 'file'
                        });
                    }
                });
                return res;
            }, [queryStr, tarifs]);

            const ftSearchResults = useMemo(() => {
                if (ftQueryStr.length < 2) return [];
                return fichesTechniques.filter(ft => 
                    (ft.productName && ft.productName.toLowerCase().includes(ftQueryStr.toLowerCase())) || 
                    (ft.fileName && ft.fileName.toLowerCase().includes(ftQueryStr.toLowerCase()))
                );
            }, [ftQueryStr, fichesTechniques]);

            // Stats
            const totalProductsIndexed = useMemo(() => tarifs.reduce((acc, t) => acc + (t.products ? t.products.length : 0), 0), [tarifs]);

            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-slate-100">
                    <div className="max-w-sm w-full bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 animate-fade">
                        <div className="bg-blue-600 p-8 text-center text-white">
                            <div className="flex justify-center mb-4"><div className="bg-white/20 p-3 rounded-xl"><Icon name="Box" size={32} className="text-white"/></div></div>
                            <h1 className="text-2xl font-black tracking-tight">CMGP-CAS</h1>
                            <p className="text-blue-100 text-xs font-medium mt-1">Connecteur Dropbox Intelligent</p>
                        </div>
                        <form onSubmit={handleLogin} className="p-8 space-y-4">
                            {loginError && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-xs font-bold text-center">{loginError}</div>}
                            <div><label className="text-xs font-bold text-slate-400 uppercase ml-1">Utilisateur</label><input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} /></div>
                            <div><label className="text-xs font-bold text-slate-400 uppercase ml-1">Mot de passe</label><input type="password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} /></div>
                            <button className="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-800 transition-transform active:scale-95">SE CONNECTER</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col bg-slate-50 font-sans text-slate-800">
                    <nav className="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 sticky top-0 z-50">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('search')}>
                            <div className="bg-blue-600 p-1.5 rounded-lg"><Icon name="Box" className="text-white" size={18}/></div>
                            <span className="font-black text-lg tracking-tight text-slate-800">CMGP<span className="text-blue-600">DBX</span></span>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setView('search')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${view === 'search' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Recherche</button>
                            <button onClick={() => setView('admin')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${view === 'admin' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Admin & Sync</button>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-5xl w-full mx-auto p-6">
                        {view === 'search' && (
                            <div className="animate-fade">
                                <div className="flex justify-center gap-4 mb-8">
                                    <button onClick={() => setSearchTab('tarifs')} className={`flex items-center gap-2 px-6 py-3 rounded-full font-bold text-sm transition-all ${searchTab === 'tarifs' ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'bg-white text-slate-400 border border-slate-200 hover:bg-slate-50'}`}><Icon name="DollarSign" size={16}/> Tarifs</button>
                                    <button onClick={() => setSearchTab('ft')} className={`flex items-center gap-2 px-6 py-3 rounded-full font-bold text-sm transition-all ${searchTab === 'ft' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-white text-slate-400 border border-slate-200 hover:bg-slate-50'}`}><Icon name="FileText" size={16}/> Fiches Techniques</button>
                                </div>

                                {searchTab === 'tarifs' && (
                                    <div className="max-w-2xl mx-auto">
                                        <div className="text-center mb-6">
                                            <div className="inline-flex items-center gap-2 px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-bold shadow-sm border border-blue-100">
                                                <Icon name="Database" size={12}/> {totalProductsIndexed} produits index√©s ({tarifs.length} fichiers)
                                            </div>
                                        </div>

                                        <div className="relative mb-8 group"><div className="absolute inset-y-0 left-4 flex items-center pointer-events-none text-slate-300 group-focus-within:text-blue-500 transition-colors"><Icon name="Search" size={20}/></div><input className="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl shadow-sm focus:ring-4 focus:ring-blue-50 outline-none text-lg transition-all placeholder:text-slate-300" placeholder="Rechercher un produit (ex: Pompe X200)..." value={queryStr} onChange={e => setQueryStr(e.target.value)}/></div>
                                        
                                        <div className="space-y-3">
                                            {searchResults.length > 0 ? searchResults.map((p, i) => (
                                                <div key={i} className={`bg-white p-4 rounded-xl border transition-all group flex items-center justify-between cursor-default ${p.type === 'file' ? 'border-orange-200 bg-orange-50/30' : 'border-slate-100 hover:border-blue-300 hover:shadow-md'}`}>
                                                    <div className="flex items-center gap-4">
                                                        <div className={`w-10 h-10 rounded-lg flex items-center justify-center font-bold text-lg ${p.type === 'file' ? 'bg-orange-100 text-orange-600' : 'bg-blue-50 text-blue-600'}`}>
                                                            {p.type === 'file' ? <Icon name="File" size={18}/> : (p.name ? p.name.charAt(0).toUpperCase() : '?')}
                                                        </div>
                                                        <div>
                                                            <div className="font-bold text-slate-800">{p.name || "Produit sans nom"}</div>
                                                            <div className="text-xs text-slate-400 font-medium flex items-center gap-1">
                                                                <Icon name="Box" size={10}/> {p.packaging || '-'} ‚Ä¢ <span className="text-blue-400">{p.source}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-xl font-black text-slate-800">{p.type === 'file' ? '' : p.price} <span className="text-xs font-bold text-slate-400">{p.type === 'file' ? '' : 'DH'}</span></div>
                                                        <button onClick={() => openDropboxFile(p.path)} className="text-[10px] font-bold text-blue-600 hover:underline mt-1 flex items-center justify-end gap-1">Voir Source <Icon name="ExternalLink" size={10}/></button>
                                                    </div>
                                                </div>
                                            )) : (
                                                queryStr.length > 1 && <div className="text-center py-12 text-slate-400"><Icon name="Ghost" size={32} className="mx-auto mb-2 opacity-50"/><p>Aucun produit trouv√©.</p></div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {searchTab === 'ft' && (
                                    <div className="max-w-2xl mx-auto">
                                        <div className="relative mb-8 group"><div className="absolute inset-y-0 left-4 flex items-center pointer-events-none text-slate-300 group-focus-within:text-indigo-500 transition-colors"><Icon name="Search" size={20}/></div><input className="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl shadow-sm focus:ring-4 focus:ring-indigo-50 outline-none text-lg transition-all placeholder:text-slate-300" placeholder="Rechercher une fiche technique..." value={ftQueryStr} onChange={e => setFtQueryStr(e.target.value)}/></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            {ftSearchResults.length > 0 ? ftSearchResults.map((ft, i) => (
                                                <div key={i} onClick={() => openDropboxFile(ft.path)} className="bg-white p-4 rounded-xl border border-slate-100 hover:border-indigo-300 hover:shadow-md transition-all cursor-pointer group">
                                                    <div className="flex items-start justify-between mb-3"><div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><Icon name="FileText" size={20}/></div><span className="text-[10px] font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">PDF</span></div>
                                                    <h3 className="font-bold text-slate-700 group-hover:text-indigo-600 transition-colors line-clamp-2">{ft.productName}</h3><p className="text-xs text-slate-400 mt-1 truncate">{ft.fileName}</p>
                                                </div>
                                            )) : (
                                                ftQueryStr.length > 1 && <div className="col-span-2 text-center py-12 text-slate-400">Aucune fiche trouv√©e.</div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'admin' && (
                            <div className="animate-fade">
                                <div className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                                    <div className="flex items-center gap-4 mb-8"><div className="bg-blue-600 text-white p-3 rounded-xl"><Icon name="Cloud" size={24}/></div><div><h2 className="text-xl font-bold text-slate-800">Centre de Synchronisation</h2><p className="text-sm text-slate-500">G√©rez la connexion avec Dropbox</p></div></div>
                                    <div className="flex gap-4 mb-6 border-b border-slate-100 pb-1">
                                        <button onClick={() => setAdminTab('sync')} className={`pb-3 px-2 text-sm font-bold border-b-2 transition-colors ${adminTab === 'sync' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>√âtat & Sync</button>
                                        <button onClick={() => setAdminTab('config')} className={`pb-3 px-2 text-sm font-bold border-b-2 transition-colors ${adminTab === 'config' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>Configuration</button>
                                    </div>

                                    {adminTab === 'sync' && (
                                        <div className="space-y-6">
                                            <div className="bg-slate-50 rounded-2xl p-6 border border-slate-200 flex flex-col md:flex-row items-center justify-between gap-6">
                                                <div><div className="text-xs font-bold text-slate-400 uppercase mb-1">Derni√®re mise √† jour</div><div className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="Clock" size={18} className="text-slate-400"/>{syncInfo.lastSync || "Jamais"}</div><div className="text-xs text-slate-500 mt-2">{tarifs.length} tarifs ‚Ä¢ {fichesTechniques.length} fiches index√©es</div></div>
                                                <div className="flex flex-col gap-2">
                                                    <button onClick={() => runSync(false)} disabled={syncStatus === 'loading'} className={`px-6 py-3 rounded-xl font-bold text-white shadow-lg flex items-center gap-2 transition-all ${syncStatus === 'loading' ? 'bg-slate-400 cursor-wait' : 'bg-blue-600 hover:bg-blue-700 active:scale-95'}`}><Icon name={syncStatus === 'loading' ? 'Loader2' : 'RefreshCw'} className={syncStatus === 'loading' ? 'animate-spin' : ''}/>{syncStatus === 'loading' ? 'Scan en cours...' : 'Synchroniser Maintenant'}</button>
                                                    <button onClick={() => { if(confirm('Voulez-vous vraiment effacer l\'index local et tout rescanner ?')) runSync(true); }} disabled={syncStatus === 'loading'} className="text-xs text-red-400 hover:text-red-600 underline text-center">Forcer Re-Scan Complet</button>
                                                </div>
                                            </div>
                                            <div className="bg-slate-900 rounded-xl p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto"><div className="opacity-50 mb-2"># Console de synchronisation Dropbox...</div>{syncLog && <div className="whitespace-pre-line">> {syncLog}</div>}</div>
                                        </div>
                                    )}

                                    {adminTab === 'config' && (
                                        <div className="space-y-6 max-w-lg">
                                            <div className="bg-yellow-50 text-yellow-800 p-4 rounded-xl text-xs border border-yellow-100 leading-relaxed"><strong className="block mb-1">Comment obtenir le Token ?</strong>1. Allez sur <a href="https://www.dropbox.com/developers/apps" target="_blank" className="underline font-bold">Dropbox Developers</a>.<br/>2. Cr√©ez une app ("Scoped access", "Full Dropbox").<br/>3. Dans l'onglet "Permissions", cochez <code>files.content.read</code>.<br/>4. Dans l'onglet "Settings", g√©n√©rez un "Generated Access Token".</div>
                                            <div className="bg-blue-50 text-blue-900 p-4 rounded-xl text-xs border border-blue-100 flex justify-between items-center"><div><strong className="block">Sauvegarder / Restaurer</strong><span className="opacity-75">Pour migrer vers un autre h√©bergement (ou Local)</span></div><div className="flex gap-2"><button onClick={handleExportConfig} className="bg-white border border-blue-200 text-blue-600 px-3 py-1.5 rounded-lg hover:bg-blue-50 font-bold shadow-sm flex items-center gap-1"><Icon name="Download" size={14}/> Exporter</button><button onClick={() => fileInputRef.current.click()} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 font-bold shadow-sm flex items-center gap-1"><Icon name="Upload" size={14}/> Importer</button><input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleImportConfig} /></div></div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Token d'Acc√®s Dropbox</label><input type="password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm" placeholder="sl.BHz..." value={dbxConfig.token} onChange={e => setDbxConfig({...dbxConfig, token: e.target.value})}/></div>
                                            <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Dossier Tarifs</label><input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="/Tarifs" value={dbxConfig.pathTarifs} onChange={e => setDbxConfig({...dbxConfig, pathTarifs: e.target.value})}/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Dossier Fiches</label><input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="/Fiches" value={dbxConfig.pathFT} onChange={e => setDbxConfig({...dbxConfig, pathFT: e.target.value})}/></div></div>
                                            <div className="pt-4"><button onClick={() => { alert('Configuration sauvegard√©e !'); setAdminTab('sync'); }} className="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-900">Sauvegarder</button></div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>